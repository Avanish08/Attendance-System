<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Show Attendance</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    function calculateTotal(rowId, maxMarks, numSubs) {
      let row = document.getElementById(rowId);
      let inputs = row.querySelectorAll(".mark-input");
      let total = 0;
      inputs.forEach(inp => total += parseInt(inp.value || 0));
      let percentage = ((total / (numSubs * maxMarks)) * 100).toFixed(2);
      row.querySelector(".total-cell").innerText = total;
      row.querySelector(".percent-cell").innerText = percentage + "%";
    }
  </script>
</head>
<body class="container mt-4">
  <div class="d-flex justify-content-between mb-3">
    <h2>üìä Attendance Records (AIML Dept.)</h2>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚¨Ö Dashboard</a>
  </div>

  <!-- üîπ Filter -->
  <form method="GET" class="row g-3 mb-4">
    <div class="col-md-4">
      <label class="form-label">Year</label>
      <select name="year" class="form-select" required>
        <option value="SE" {% if year == "SE" %}selected{% endif %}>S.E</option>
        <option value="TE" {% if year == "TE" %}selected{% endif %}>T.E</option>
        <option value="BE" {% if year == "BE" %}selected{% endif %}>B.E</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Date</label>
      <input type="date" name="date" class="form-control" value="{{ date }}">
    </div>
    <div class="col-md-4 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">üîç Filter</button>
    </div>
  </form>

  <!-- üîπ Attendance Table -->
  <form method="POST">
    <table class="table table-bordered">
      <thead class="table-light">
        <tr>
          <th>Roll No</th>
          <th>Name</th>
          {% for sub in subjects %}
            <th>{{ sub.subject_name }}</th>
          {% endfor %}
          <th>Total</th>
          <th>Percentage</th>
        </tr>
      </thead>
      <tbody>
        {% for rec in records %}
        <tr id="row{{ loop.index }}">
          <td>
            {{ rec.rollno }}
            <input type="hidden" name="student_ids[]" value="{{ rec.student_id }}">
          </td>
          <td>{{ rec.name }}</td>

          {% for sub in subjects %}
          <td>
            <input type="number"
                   name="{{ sub._id }}_{{ rec.student_id }}"
                   value="{{ rec[sub.subject_name] if rec[sub.subject_name] is defined else 0 }}"
                   min="0" max="7"
                   class="form-control mark-input"
                   oninput="calculateTotal('row{{ loop.index }}', 7, {{ subjects|length }})">
          </td>
          {% endfor %}

          <td class="total-cell">{{ rec.total if rec.total is defined else 0 }}</td>
          <td class="percent-cell">{{ rec.percentage if rec.percentage is defined else 0 }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button class="btn btn-success">üíæ Save Updates</button>
 

    <a href="{{ url_for('attendance_report') }}" class="btn btn-primary">üìÑ Download Report</a>
  </form>
</body>
</html>
