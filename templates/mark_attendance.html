<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mark Attendance</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script>
    function calculateRowTotal(rowId) {
      const row = document.getElementById(rowId);
      const inputs = row.querySelectorAll(".mark-input");
      let total = 0;
      inputs.forEach(inp => {
        const v = parseInt(inp.value || 0);
        if (!isNaN(v)) total += v;
      });
      row.querySelector(".total-cell").innerText = total;
    }
  </script>
</head>
<body class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>ðŸ“Œ Mark Attendance</h2>
    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">â¬… Dashboard</a>
  </div>

  <!-- Filter (GET) -->
  <form method="GET" class="row g-3 mb-4" action="{{ url_for('mark_attendance') }}">
    <div class="col-md-4">
      <label class="form-label">Department</label>
      <select class="form-select" name="department" required>
        <option value="AIML" {% if department=='AIML' %}selected{% endif %}>AIML</option>
        <option value="CSE"  {% if department=='CSE' %}selected{% endif %}>CSE</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Year</label>
      <select class="form-select" name="year" required>
        <option value="SE" {% if year=='SE' %}selected{% endif %}>S.E (2nd Year)</option>
        <option value="TE" {% if year=='TE' %}selected{% endif %}>T.E (3rd Year)</option>
        <option value="BE" {% if year=='BE' %}selected{% endif %}>B.E (4th Year)</option>
      </select>
    </div>
    <div class="col-md-4 align-self-end">
      <button class="btn btn-primary">Load</button>
    </div>
  </form>

  {% if students|length == 0 %}
    <div class="alert alert-warning">No students found for {{ department }} - {{ year }}.</div>
  {% endif %}

  {% if subjects|length == 0 %}
    <div class="alert alert-info">No subjects/practicals configured for {{ department }} - {{ year }}. Add them in Manage Subjects.</div>
  {% endif %}

  {% if students and subjects %}
  <!-- Save (POST) -->
  <form method="POST" action="{{ url_for('mark_attendance') }}">
    <!-- preserve filters -->
    <input type="hidden" name="department" value="{{ department }}">
    <input type="hidden" name="year" value="{{ year }}">

    <table class="table table-bordered align-middle">
      <thead class="table-light">
        <tr>
          <th style="width: 90px;">Roll No</th>
          <th style="min-width: 180px;">Name</th>
          {% for subject in subjects %}
            <th>
              {{ subject.subject_name }}
              {% if subject.type %}<div class="small text-muted">{{ subject.type|capitalize }}</div>{% endif %}
            </th>
          {% endfor %}
          <th style="width: 90px;">Total</th>
        </tr>
      </thead>
      <tbody>
        {% for s in students %}
        <tr id="row{{ loop.index }}">
          <td>
            {{ s.rollno }}
            <input type="hidden" name="student_ids[]" value="{{ s._id }}">
          </td>
          <td>{{ s.name }}</td>

          {% for subject in subjects %}
          <td>
            <input
              type="number"
              class="form-control mark-input"
              name="{{ s._id }}__{{ subject._id }}"
              min="0" max="7" value="0"
              oninput="calculateRowTotal('row{{ loop.index }}')"
              required
            >
          </td>
          {% endfor %}

          <td class="total-cell">0</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button class="btn btn-success">Submit Attendance</button>
  </form>
  {% endif %}
</body>
</html>
